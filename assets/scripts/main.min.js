const version=1.3,url="http://"+window.location.hostname+"/",activeLang=localStorage.getItem("lang");let iconsUrl="assets/images/",tilesUrl="assets/map/{z}_{x}_{y}.jpg",maxNativeZoom=5,mapMinZoom=1,mapMaxZoom=5,mapSize=8192,tileSize=256,mapScale=mapSize/tileSize,mapOffset=mapSize/mapScale/2,halfTile=tileSize/2,mapBounds=4096;L.CRS.MySimple=L.extend({},L.CRS.Simple,{transformation:new L.Transformation(1/16,0,-1/16,256)});let myBounds=[[0,0],[mapBounds,mapBounds]],map=L.map("map",{maxNativeZoom:maxNativeZoom,minZoom:mapMinZoom,maxZoom:mapMaxZoom,zoomControl:!1,fullscreenControl:!0,fullscreenControlOptions:{position:"topright"},crs:L.CRS.MySimple,scrollWheelZoom:!1,smoothWheelZoom:!0,smoothSensitivity:1}).setView([2048,2048],2);L.tileLayer.canvas(tilesUrl,{maxNativeZoom:maxNativeZoom,minZoom:mapMinZoom,maxZoom:mapMaxZoom,tileSize:tileSize,noWrap:!0,tms:!1,bounds:myBounds,continuousWorld:!0}).addTo(map),map.setMaxBounds([[-3e3,-3e3],[7e3,7e3]]),window.latLngToPixels=function(t){return window.map.project([t.lat,t.lng],window.map.getMaxZoom())},window.pixelsToLatLng=function(t,a){return window.map.unproject([t,a],window.map.getMaxZoom())};let popup=L.popup();new L.Control.Zoom({position:"topright"}).addTo(map);let sidebar=L.control.sidebar("sidebar").addTo(map);sidebar.open("home");let hash=new L.Hash(map);function gridfix(){let t=L.GridLayer.prototype._initTile;L.GridLayer.include({_initTile:function(a){t.call(this,a);let n=this.getTileSize();a.style.width=n.x+.5+"px",a.style.height=n.y+.5+"px"}})}L.Control.Coordinates.include({_update:function(t){let a=t.latlng,n=this.options;a&&(this._currentPos=a,this._inputY.value=L.NumberFormatter.round(a.lat,n.decimals,n.decimalSeperator),this._inputX.value=L.NumberFormatter.round(a.lng,n.decimals,n.decimalSeperator),this._label.innerHTML=this._createCoordinateLabel(a))}}),L.control.coordinates({position:"bottomright",decimals:0,decimalSeperator:".",labelTemplateLat:"Y: {y}",labelTemplateLng:"X: {x}",enableUserInput:!0,useDMS:!1,useLatLngOrder:!1,markerType:L.marker,markerProps:{}}).addTo(map);let layerGroups=[],textLayer=[],globalMarkers=[],transparentMarker=L.icon({iconUrl:iconsUrl+"alpha_marker.png",iconSize:[1,1],iconAnchor:[18,18],popupAnchor:[0,-18]});for(let i=0;i<textMarkers.length;i++){void 0==layerGroups.textmarkers&&(layerGroups.textmarkers=new L.LayerGroup);let t=new L.marker(textMarkers[i].coords,{opacity:0,icon:transparentMarker});t.bindTooltip(textMarkers[i].name,{permanent:!0,direction:"top",className:"text-label",offset:[0,0]}),t.addTo(layerGroups.textmarkers)}function getIcon(t){let a=markers[t].icon;return L.icon({iconUrl:iconsUrl+a+".png",iconSize:[36,36],iconAnchor:[18,18],popupAnchor:[0,-18]})}map.on("zoomend",function(t){let a=map.getZoom();switch(a){case 0:$(".text-label").css("visibility","visible"),$(".text-label span").css("font-size","12px"),$(".text-label.secondary").css("visibility","hidden");break;case 1:$(".text-label").css("visibility","visible"),$(".text-label span").css("font-size","14px"),$(".text-label.secondary").css("visibility","hidden");break;case 2:$(".text-label").css("visibility","visible"),$(".text-label span").css("font-size","16px"),$(".text-label.secondary").css("visibility","hidden");break;case 3:$(".text-label").css("visibility","visible"),$(".text-label span").css("font-size","18px"),$(".text-label.secondary").css("visibility","hidden");break;case 4:case 5:$(".text-label").css("visibility","visible"),$(".text-label span").css("font-size","20px"),$(".text-label.secondary").css("visibility","hidden")}});for(let i=0;i<markers.length;i++){void 0==layerGroups[markers[i].group]&&(layerGroups[markers[i].group]=new L.LayerGroup),void 0==markers[i].desc&&(markers[i].desc=""),void 0==markers[i].items&&(markers[i].items=""),void 0==markers[i].kcditems&&(markers[i].kcditems="");let a="";for(let n in markers[i].kcditems)markers[i].kcditems[n],a+='<li><i class="'+markers[i].kcditems[n].item+'"></i><span class="iname" data-i18n="'+markers[i].kcditems[n].item+'">'+markers[i].kcditems[n].item.replace(/_/gi," ")+'</span><span class="qnt">'+markers[i].kcditems[n].qnt+"</span></li>";let r=markers[i].coords[1].toFixed(0),o=markers[i].coords[0].toFixed(0),s=markers[i].coords[1].toFixed(0),l=markers[i].coords[0].toFixed(0),c=url+"?marker="+o+","+r;c=encodeURI(c);let d=L.marker([r,o],{icon:getIcon(i),title:markers[i].group}).bindPopup("<p class='mtitle'>"+markers[i].name+"</p><span class='mdesc'>"+markers[i].desc+"</span><ul class='ilist'>"+a+"</ul><p class='original_coords'>"+l+","+s+"</p><p class='markerlink hide'>"+c+"</p><button class='copymarkerurl'><span class='sharetext'  data-i18n='copylink'>Linki Kopyala</span><span class='copiedmsg hide'>Kopyalandı</span></button>").addTo(layerGroups[markers[i].group]);globalMarkers.push(d)}function getIconUsr(t){let a=usr_markers[t].icon;return L.icon({iconUrl:iconsUrl+a+".png",iconSize:[36,36],iconAnchor:[18,18],popupAnchor:[0,-18]})}for(let i=0;i<usr_markers.length;i++){let p=usr_markers[i];void 0==layerGroups[p.group]&&(layerGroups[p.group]=new L.LayerGroup),void 0==p.desc&&(p.desc=""),void 0==p.desc2&&(p.desc2=""),void 0==p.items&&(p.items="");let m="";void 0!=p.req&&(p.req=void 0==p.req?"":p.req,p.level=void 0==p.level?"":p.level,m='<p class="req" data-i18n="req">Gereksinimler:</p><ul class="ilist"><li><i class="'+p.req+'"></i><span class="iname" data-i18n="'+p.req+'">'+p.req.replace(/_/gi," ")+'</span><span class="ilevel '+p.level+'" data-i18n="'+p.level+'">'+p.level.replace(/_/gi," ")+"</span></li>");let h="";for(let u in p.items)h+='<li><i class="'+p.items[u]+'"></i><span class="iname" data-i18n="'+p.items[u]+'">'+p.items[u].replace(/_/gi," ")+"</span></li>";let g=p.coords[1],v=p.coords[0],k=url+"?marker="+v+","+g;k=encodeURI(k);let f=L.marker([g,v],{icon:getIconUsr(i),title:p.name}).bindPopup("<p class='mtitle'>"+p.name+"</p><p class='mdesc'>"+p.desc+"</p><p class='mdesc'>"+p.desc2+"</p>"+m+"<ul class='ilist'>"+h+"</ul><p class='original_coords'>"+v+","+g+"</p><p class='markerlink hide'>"+k+"</p><button class='copymarkerurl'><span class='sharetext'  data-i18n='share'>Paylaş</span><span class='copiedmsg hide'>Kopyalandı</span></button>").addTo(layerGroups[p.group]);globalMarkers.push(f)}function toggle(t,a){t.checked?map.addLayer(layerGroups[a]):($("#allmarkers").prop("checked",!1),map.removeLayer(layerGroups[a]))}let allmarkers=document.getElementById("allmarkers");function toggleAll(t){if(t.checked)for(let a in $(".markers-list input").prop("checked",!0),layerGroups)map.addLayer(layerGroups[a]);else for(let n in $(".markers-list input").prop("checked",!1),layerGroups)map.removeLayer(layerGroups[n])}function getUrlVars(){let t={};return window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(a,n,r){t[n]=r}),t}allmarkers.onchange=function(){toggleAll(this)},$(allmarkers).click(function(){if(!0==$(this).prop("checked")){let t,a=[];$(".markers-list input").each(function(){t={id:$(this).attr("id"),value:$(this).prop("checked")},a.push(t)}),localStorage.setItem("activemarkers",JSON.stringify(a))}else!1==$(this).prop("checked")&&localStorage.setItem("activemarkers","[]")}),$(".markers-list input").each(function(){this.onchange=function(){toggle(this,this.id),"textmarkers"==this.id&&($(this.id).is(":checked")?($(".text-label").css("visibility","hidden"),$(".text-label.secondary").css("visibility","hidden")):($(".text-label").css("visibility","visible"),$(".text-label").css("font-size","24px"),$(".text-label.secondary").css("visibility","hidden")))}});let urlCoordinates=getUrlVars().marker;if(void 0!=urlCoordinates){let b=!1;for(let y in sidebar.close(),getUrlVars().zoom>=1&&getUrlVars().zoom<=4&&getUrlVars().zoom,globalMarkers){let x=globalMarkers[y]._latlng.lat;globalMarkers[y]._latlng.lng+","+x==urlCoordinates&&($("#"+globalMarkers[y].options.title).prop("checked",!0),map.addLayer(layerGroups[globalMarkers[y].options.title]),map.flyTo(globalMarkers[y].getLatLng(),urlZoom),"false"!=getUrlVars().popup&&globalMarkers[y].openPopup(),b=!0)}if(!1==b){let _=urlCoordinates.split(",")[1],w=urlCoordinates.split(",")[0];if(_<=mapBounds&&_>0&&w<=mapBounds&&w>0){let C=L.marker([_,w]);map.flyTo(C.getLatLng(),urlZoom),C=null}_=null,w=null}}function copy(t){let a=$("<input>");$("body").append(a),a.val($(t).text()).select(),document.execCommand("copy"),a.remove()}$(document).on("click",".copymarkerurl",function(){let t=$(this).parent().find(".markerlink"),a=$("<input>");$("body").append(a),a.val($(t).text()).select(),document.execCommand("copy"),$(".copiedmsg").fadeIn({queue:!1,duration:"300"}),$(".copiedmsg").delay(1e3).fadeOut(300),a.remove()});let locatedGroup=L.layerGroup();function numonly(t){$("#mlat,#mlon").keyup(function(){let t=$(this).val().replace(/-?\d+[^0-9]+/,"");/^\s*$/.test(t),t=t>0?parseInt(t)>2934?2934:t:parseInt(t)>-2394?t:-2394,$(this).val(t)})}function getAObj(t,a){for(e in t)if(t[e].name==a)return t[e].value;return 0}markers.forEach(function(t){let a=L.marker(t.latLng,{title:t.name,riseOnHover:!0}).bindPopup(t.name);locatedGroup.addLayer(a),t.marker_id=locatedGroup.getLayerId(a)}),markers.forEach(function(t){$(".locate").on("click",function(){if($(this).attr("data-marker")==t.title){let a=L.icon({iconUrl:iconsUrl+"alpha_marker.png",iconSize:[iWidth,iHeight],iconAnchor:[iWidth/2,iHeight],popupAnchor:[0,-iHeight]});$("#"+t.group).prop("checked",!0),map.addLayer(layerGroups[t.group]);let n=L.marker(t.coords,{icon:a}).bindPopup(t.name+"<br>"+t.desc).addTo(map);map.panTo(n.getLatLng()),n.openPopup(),n.on("popupclose",function(){map.removeLayer(n)})}})});let mapMarkers=[{icon:"arrow",width:"36",height:"36"},{icon:"accident",width:"36",height:"36"},{icon:"alchemy_bench",width:"36",height:"36"},{icon:"apothecary",width:"36",height:"36"},{icon:"archery_range",width:"36",height:"36"},{icon:"armourer",width:"36",height:"36"},{icon:"baker",width:"36",height:"36"},{icon:"bandit_camp",width:"36",height:"36"},{icon:"baths",width:"36",height:"36"},{icon:"beehive",width:"36",height:"36"},{icon:"blacksmith",width:"36",height:"36"},{icon:"boar_hunting_spot",width:"36",height:"36"},{icon:"butcher",width:"36",height:"36"},{icon:"camp",width:"36",height:"36"},{icon:"cave",width:"36",height:"36"},{icon:"charcoal_burner",width:"36",height:"36"},{icon:"cobbler",width:"36",height:"36"},{icon:"combat_arena",width:"36",height:"36"},{icon:"conciliation_cross",width:"36",height:"36"},{icon:"deer_hunting_spot",width:"36",height:"36"},{icon:"fast_travel",width:"64",height:"64"},{icon:"fish_trap",width:"36",height:"36"},{icon:"fishing_spot",width:"36",height:"36"},{icon:"grave",width:"36",height:"36"},{icon:"grindstone",width:"36",height:"36"},{icon:"grocer",width:"36",height:"36"},{icon:"herbalist",width:"36",height:"36"},{icon:"home",width:"36",height:"36"},{icon:"horse_trader",width:"36",height:"36"},{icon:"huntsman",width:"36",height:"36"},{icon:"interesting_site",width:"36",height:"36"},{icon:"lodgings",width:"36",height:"36"},{icon:"miller",width:"36",height:"36"},{icon:"nest",width:"36",height:"36"},{icon:"scribe",width:"36",height:"36"},{icon:"shrine",width:"36",height:"36"},{icon:"tailor",width:"36",height:"36"},{icon:"tanner",width:"36",height:"36"},{icon:"tavern",width:"36",height:"36"},{icon:"trader",width:"36",height:"36"},{icon:"treasure_chest",width:"36",height:"36"},{icon:"treasure_map",width:"36",height:"36"},{icon:"treasure_map_alt",width:"36",height:"36"},{icon:"weaponsmith",width:"36",height:"36"},{icon:"woodland_garden",width:"36",height:"36"},{icon:"belladonna",width:"36",height:"36"},{icon:"chamomile",width:"36",height:"36"},{icon:"comfrey",width:"36",height:"36"},{icon:"dandelion",width:"36",height:"36"},{icon:"eyebright",width:"36",height:"36"},{icon:"herb_paris",width:"36",height:"36"},{icon:"marigold",width:"36",height:"36"},{icon:"mint",width:"36",height:"36"},{icon:"nettle",width:"36",height:"36"},{icon:"poppy",width:"36",height:"36"},{icon:"sage",width:"36",height:"36"},{icon:"st_johns_wort",width:"36",height:"36"},{icon:"thistle",width:"36",height:"36"},{icon:"valerian",width:"36",height:"36"},{icon:"wormwood",width:"36",height:"36"},{icon:"marker_a",width:"36",height:"36"},{icon:"marker_b",width:"36",height:"36"},{icon:"marker_c",width:"36",height:"36"},{icon:"star",width:"36",height:"36"},{icon:"exclamation",width:"36",height:"36"},],markerIconTypes=[];for(let i in mapMarkers){let U=mapMarkers[i].icon,M=mapMarkers[i].width,T=mapMarkers[i].height;markerIconTypes[i]=L.icon({className:"",iconUrl:iconsUrl+U.replace(/ /g,"")+".png",iconSize:[M,T],iconAnchor:[M/2,T/2,],popupAnchor:[0,-T/2]})}let groupUser=[];function initUserLayerGroup(){let t=[];if("undefined"==localStorage.mapUserMarkers&&(localStorage.mapUserMarkers="[]"),void 0!==localStorage.mapUserMarkers){let a=[];a=JSON.parse(localStorage.mapUserMarkers);for(let n=0;n<a.length;n++){let r=a[n].coords.x,o=a[n].coords.y,s=a[n].name;a[n].icon;let l=a[n].iconvalue,c=a[n].icon.options.iconUrl,d=a[n].title,p=a[n].desc,m=url+"?m="+o+","+r+"&title="+s+"&desc="+p+"&icon="+l+"&";m=encodeURI(m);let h=L.icon({iconUrl:a[n].icon.options.iconUrl,iconSize:a[n].icon.options.iconSize,iconAnchor:[18,18],popupAnchor:[0,-18],className:a[n].icon.options.className}),u='<div class="popcontent">			<p class="mtitle">'+s+'</p>			<p class="mdesc">'+p+'</p>			<span class="mcoords">X: '+o+" Y: "+r+'</span></div>      <span class="markerlink hide">'+m+'</span>      <button class="copymarkerurl"><span class="sharetext" data-i18n="copylink">'+get.interactive.cp_link[activeLang]+'</span>      <span class="copiedmsg hide">Copied</span></button>			<button class="edit-marker" data-i18n="edit_marker">'+get.interactive.edit_marker[activeLang]+'</button>			<div id="edit-dialog" class="hide">			<div class="chooseIcon" data-i18n="choose_icon">'+get.interactive.add_icon_title[activeLang]+'</div>			<div id="iconprev" style="background-image:url(\''+c+'\')"></div>			<select id="select_icon" name="icon" onchange="iconpref(this.value);">';for(let g in mapMarkers)u+='<option value="'+g+'">'+mapMarkers[g].icon.replace(/_/gi," ")+"</option>";u=u+'</select>			<input type="text" id="editedtitle" name="title" value="'+d+'">			<textarea id="editeddesc" name="desc">'+p+'</textarea>			<button class="cancel" data-i18n="cancel">'+get.interactive.textarea.cancel[activeLang]+'</button>			<button class="save-marker" data-i18n="Save">'+get.interactive.textarea.save[activeLang]+'</button>			</div>			<button class="remove-marker" data-i18n="remove_marker">'+get.interactive.remove[activeLang]+'</button>			<div id="remove-dialog" class="hide">			<span class="remove-text" data-i18n="remove_text">'+get.interactive.dialog.title[activeLang]+'</span>			<button class="yes" data-i18n="yes">'+get.interactive.dialog.yes[activeLang]+'</button>			<button class="no" data-i18n="no">'+get.interactive.dialog.no[activeLang]+"</button></div>";let v=L.marker([r,o],{draggable:!1,icon:h}).bindPopup(u);v.on("popupopen",onPopupOpen),t.push(v)}}else localStorage.mapUserMarkers="[]";groupUser=L.layerGroup(t),map.addLayer(groupUser)}initUserLayerGroup();let actualversion=localStorage.getItem("version");if(null===actualversion||actualversion<1.3){localStorage.setItem("version",1.3),console.log("version outdated"),storageMarkers=JSON.parse(localStorage.mapUserMarkers);for(let I=0;I<storageMarkers.length;I++){let A=storageMarkers[I].coords.x,S=storageMarkers[I].coords.y;A=(A/2932*2048+2048).toFixed(0),S=(S/2932*2048+2048).toFixed(0),storageMarkers[I].coords.x=A,storageMarkers[I].coords.y=S,localStorage.mapUserMarkers=JSON.stringify(storageMarkers),map.removeLayer(groupUser),initUserLayerGroup()}}function iconpref(t){document.getElementById("iconprev").style.backgroundImage="url("+markerIconTypes[t].options.iconUrl+")"}function titlepref(t){document.getElementById("titleprev").value=t.replace(/_/gi," ")}function removeMarkerE(t,a){for(e in markers){let n=markers[e].getLatLng();n.lat==t&&n.lng==a&&map.removeLayer(markers[e])}}function addMarkerText(t,a){let n='<div class="chooseIcon" data-i18n="choose_icon">'+get.interactive.add_icon_title[activeLang]+'</div>  <div id="iconprev" style="background-image:url(\''+markerIconTypes[0].options.iconUrl+'\')"></div>  <form id="addmark" method="post" action="#">  <select id="select_icon" name="icon" onchange="iconpref(this.value); titlepref(this.options[this.selectedIndex].innerHTML);">';for(let r in mapMarkers)n+='<option value="'+r+'">'+mapMarkers[r].icon.replace(/_/gi," ")+"</option>";n=n+'</select><div class="markertitle" data-i18n="marker_title">'+get.interactive.marker_title[activeLang]+'</div>  <input type="text" id="titleprev" name="title" value="Arrow">  <div class="markerdesc" data-i18n="marker_desc">'+get.interactive.marker_description[activeLang]+'</div>  <textarea name="desc" onclick="this.value=\'\'; this.onclick = function(){}"></textarea>  <table class="coordsinputs">  <tr>  <td>X:<input type="text" readonly="readonly" name="mlon" id="mlon" maxlength="5" value="'+a+'" onKeyPress="return numonly(this,event)"></td>  <td>Y:<input id="mlat" type="text" readonly="readonly" name="mlat" maxlength="5" value="'+t+'" onKeyPress="return numonly(this,event)"></td>  </tr>  </table>  <input type="hidden" name="submit" value="true">  <button type="submit" class="send" data-i18n="add">'+get.interactive.add[activeLang]+"</button>  </form>";let o={};o.lat=t,o.lng=a,popup.setLatLng(o).setContent(n).openOn(map),$("#addmark").submit(function(t){$(this).find("#select_icon option:selected").text();let a=$(this).serializeArray(),n=Math.round(getAObj(a,"mlat")),r=Math.round(getAObj(a,"mlon"));a.push({name:"lat",value:n}),a.push({name:"lon",value:r});let o=[];void 0!==localStorage.mapUserMarkers&&(o=JSON.parse(localStorage.mapUserMarkers)),o.push({coords:{x:n,y:r},name:getAObj(a,"title"),icon:markerIconTypes[getAObj(a,"icon")],iconvalue:getAObj(a,"icon"),title:getAObj(a,"title"),desc:getAObj(a,"desc")}),popup._close();let s=url+"?m="+r+","+n+"&title="+getAObj(a,"title")+"&desc="+getAObj(a,"desc")+"&icon="+getAObj(a,"icon")+"&";s=encodeURI(s);let l='<div class="popcontent">    <p class="mtitle">'+getAObj(a,"title")+'</p>    <p class="mdesc">'+getAObj(a,"desc")+'</p>    <span class="mcoords">[ '+getAObj(a,"mlon")+" , "+getAObj(a,"mlat")+']</span></div>    <span class="markerlink hide">'+s+'</span>    <button class="copymarkerurl"><span class="sharetext" data-i18n="copylink">'+get.interactive.cp_link[activeLang]+'</span>    <span class="copiedmsg hide">Copied</span></button>    <button class="edit-marker" data-i18n="edit_marker">'+get.interactive.edit_marker[activeLang]+'</button>    <div id="edit-dialog" class="hide">    <div class="chooseIcon" data-i18n="choose_icon">'+get.interactive.add_icon_title[activeLang]+'</div>    <div id="iconprev" style="background-image:url(\''+markerIconTypes[0].options.iconUrl+'\')"></div>    <select id="select_icon" name="icon" onchange="iconpref(this.value);">';for(let c in mapMarkers)l+='<option value="'+c+'">'+mapMarkers[c].icon.replace(/_/gi," ")+"</option>";l=l+'</select>    <input type="text" id="editedtitle" name="title" value="'+getAObj(a,"title")+'">    <textarea id="editeddesc" name="desc">'+getAObj(a,"desc")+'</textarea>    <button class="cancel" data-i18n="cancel">'+get.interactive.textarea.cancel[activeLang]+'</button>    <button class="save-marker" data-i18n="Save">'+get.interactive.textarea.save[activeLang]+'</button>    </div>    <button class="remove-marker" data-i18n="remove_marker">'+get.interactive.remove[activeLang]+'</button>    <div id="remove-dialog" class="hide">    <span class="remove-text" data-i18n="remove_text">'+get.interactive.dialog.title[activeLang]+'</span>    <button class="yes" data-i18n="yes">'+get.interactive.dialog.yes[activeLang]+'</button>    <button class="no" data-i18n="no">'+get.interactive.dialog.no[activeLang]+"</button></div>";let d=L.marker({lat:n,lng:r},{icon:markerIconTypes[getAObj(a,"icon")]});d.bindPopup(l),d.addTo(map),d.on("popupopen",onPopupOpen),[].push(d),console.log(groupUser),groupUser.addLayer(d),localStorage.mapUserMarkers=JSON.stringify(o),map.addLayer(groupUser),t.preventDefault()})}function onPopupOpen(t){let a=this,n=a.getLatLng();console.log("clickedMarkerCoords= "+n);let r=t.target.getLatLng();console.log("clickedMarkerCoordsNew= "+r);let o=a.getPopup();$(document).off("click",".remove-marker"),$(document).on("click",".remove-marker",function(){$(this).addClass("hide"),$(this).next("#remove-dialog").removeClass("hide"),$(this).parent().parent().find(".popcontent").addClass("hide"),$(this).parent().parent().find(".edit-marker").addClass("hide"),$(this).parent().parent().find(".copymarkerurl").addClass("hide")}),$(document).off("click",".no"),$(document).on("click",".no",function(){$(this).parent("#remove-dialog").addClass("hide"),$(this).parent().parent().find(".popcontent").removeClass("hide"),$(this).parent().parent().find(".edit-marker").removeClass("hide"),$(this).parent().parent().find(".remove-marker").removeClass("hide"),$(this).parent().parent().find(".copymarkerurl").removeClass("hide")}),$(document).off("click",".yes"),$(document).on("click",".yes",function(){for(i=(storageMarkers=JSON.parse(localStorage.mapUserMarkers)).length;i>-1;i--)void 0!==storageMarkers[i]&&n.lat==storageMarkers[i].coords.x&&n.lng==storageMarkers[i].coords.y&&(storageMarkers.splice(i,1),localStorage.mapUserMarkers=JSON.stringify(storageMarkers));map.removeLayer(a),groupUser.removeLayer(a)}),$(document).off("click",".edit-marker"),$(document).on("click",".edit-marker",function(){for(i=(storageMarkers=JSON.parse(localStorage.mapUserMarkers)).length;i>-1;i--)void 0!==storageMarkers[i]&&n.lat==storageMarkers[i].coords.x&&n.lng==storageMarkers[i].coords.y&&($(this).parent().find("#iconprev").css("background-image","url("+storageMarkers[i].icon.options.iconUrl+")"),$(this).parent().find("#select_icon").val(storageMarkers[i].iconvalue));$(this).addClass("hide"),$(this).next("#edit-dialog").removeClass("hide"),$(this).parent().parent().find(".popcontent").addClass("hide"),$(this).parent().parent().find(".remove-marker").addClass("hide"),$(this).parent().parent().find(".copymarkerurl").addClass("hide")}),$(document).off("click",".cancel"),$(document).on("click",".cancel",function(){$(this).parent().parent().find("#edit-dialog").addClass("hide"),$(this).parent().parent().find(".popcontent").removeClass("hide"),$(this).parent().parent().find(".edit-marker").removeClass("hide"),$(this).parent().parent().find(".remove-marker").removeClass("hide"),$(this).parent().parent().find(".copymarkerurl").removeClass("hide"),o._close()}),$(document).off("click",".save-marker"),$(document).on("click",".save-marker",function(){for(i=(storageMarkers=JSON.parse(localStorage.mapUserMarkers)).length;i>-1;i--)if(void 0!==storageMarkers[i]&&n.lat==storageMarkers[i].coords.x&&n.lng==storageMarkers[i].coords.y){let t=$(this).parent().find("select[name=icon]").val(),r=$(this).parent().find("#editedtitle").val(),s=$(this).parent().find("#editeddesc").val(),l=url+"?m="+n.lng+","+n.lat+"&title="+r+"&desc="+s+"&icon="+t+"&";l=encodeURI(l);let c='<div class="popcontent"><p class="mtitle">'+r+'</p><p class="mdesc">'+s+'</p><span class="mcoords">[ '+n.lng+" , "+n.lat+']</span></div><span class="markerlink hide">'+l+'</span><button class="copymarkerurl"><span class="sharetext" data-i18n="copylink">'+get.interactive.cp_link[activeLang]+'</span><span class="copiedmsg hide">Copied</span></button><button class="edit-marker" data-i18n="edit_marker">'+get.interactive.edit_marker[activeLang]+'</button><div id="edit-dialog" class="hide"><div class="chooseIcon" data-i18n="choose_icon">'+get.interactive.add_icon_title[activeLang]+'</div>  <div id="iconprev" style="background-image:url(\''+markerIconTypes[0].options.iconUrl+'\')"></div>  <select id="select_icon" name="icon" onchange="iconpref(this.value);">';for(let d in mapMarkers)c+='<option value="'+d+'">'+mapMarkers[d].icon.replace(/_/gi," ")+"</option>";c=c+'</select><input type="text" id="editedtitle" name="title" value="'+r+'"><textarea id="editeddesc" name="desc">'+s+'</textarea><button class="cancel" data-i18n="cancel">'+get.interactive.textarea.cancel[activeLang]+'</button><button class="save-marker" data-i18n="Save">'+get.interactive.textarea.save[activeLang]+'</button></div><button class="remove-marker" data-i18n="remove_marker">'+get.interactive.remove[activeLang]+'</button><div id="remove-dialog" class="hide"><span class="remove-text" data-i18n="remove_text">'+get.interactive.dialog.title[activeLang]+'</span><button class="yes" data-i18n="yes">'+get.interactive.dialog.yes[activeLang]+'</button><button class="no" data-i18n="no">'+get.interactive.dialog.no[activeLang]+"</button></div>",o.setContent(c),a.setIcon(markerIconTypes[t]),storageMarkers[i].name=r,storageMarkers[i].title=r,storageMarkers[i].desc=s,storageMarkers[i].icon=markerIconTypes[t],storageMarkers[i].iconvalue=t,localStorage.mapUserMarkers=JSON.stringify(storageMarkers)}o._close()})}$("#usermarkers").click(function(){!0==$(this).prop("checked")?map.addLayer(groupUser):!1==$(this).prop("checked")&&map.removeLayer(groupUser)}),map.on("click",function(t){let a=Math.round(t.latlng.lat),n=Math.round(t.latlng.lng);n<0||n>4095||a<0||a>4095?console.log("lat: "+a+"long: "+n):(message='<span class="coordsinfo">X: '+n+" Y: "+a+'</span><br><button class="add-marker" data-i18n="add_marker" onclick="addMarkerText('+a+","+n+')">'+get.interactive.add_marker_button[activeLang]+"</button>",popup.setLatLng(t.latlng).setContent(message).openOn(map))});let sharedMarker=getUrlVars().m;if(void 0!=sharedMarker){sidebar.close();let G=getUrlVars().icon,O=getUrlVars().title;O=decodeURIComponent(O);let z=getUrlVars().desc;z=decodeURIComponent(z);let j=sharedMarker.split(",")[1],P=sharedMarker.split(",")[0];console.log(O),console.log(z);let Z='<div class="popcontent"><p class="mtitle">'+O+'</p><p class="mdesc">'+z+'</p><span class="mcoords">X: '+P+" Y: "+j+'</span></div><button class="edit-marker" data-i18n="edit_marker">Edit marker</button><div id="edit-dialog" class="hide"><div class="chooseIcon" data-i18n="choose_icon">Choose Icon:</div><div id="iconprev" style="background-image:url(\''+markerIconTypes[G].options.iconUrl+'\')"></div><select id="select_icon" name="icon" onchange="iconpref(this.value);">';for(let N in mapMarkers)Z+='<option value="'+N+'">'+mapMarkers[N].icon.replace(/_/gi," ")+"</option>";if(Z=Z+'</select><input type="text" id="editedtitle" name="title" value="'+O+'"><textarea id="editeddesc" name="desc">'+z+'</textarea><button class="cancel" data-i18n="cancel">Cancel</button><button class="save-marker" data-i18n="Save">Save</button></div><button class="remove-marker" data-i18n="remove_marker">Remove marker</button><div id="remove-dialog" class="hide"><span class="remove-text" data-i18n="remove_text">Are you sure?</span><button class="yes" data-i18n="yes">Yes</button><button class="no" data-i18n="no">No</button></div>',j<=mapBounds&&j>0&&P<=mapBounds&&P>0){let q=L.marker([j,P],{icon:markerIconTypes[G]}).bindPopup(Z).addTo(map);map.flyTo(q.getLatLng(),4),q.on("popupopen",onPopupOpenShared),q.openPopup()}}function onPopupOpenShared(){let t=this,a=t.getLatLng(),n=t.getPopup(),r=getUrlVars().icon,o=getUrlVars().title;o=decodeURIComponent(o);let s=getUrlVars().desc;s=decodeURIComponent(s);let l=sharedMarker.split(",")[1],c=sharedMarker.split(",")[0],d=markerIconTypes[r].options.iconUrl;$(document).off("click",".remove-marker"),$(document).on("click",".remove-marker",function(){$(this).addClass("hide"),$(this).next("#remove-dialog").removeClass("hide"),$(this).parent().parent().find(".popcontent").addClass("hide"),$(this).parent().parent().find(".edit-marker").addClass("hide")}),$(document).off("click",".no"),$(document).on("click",".no",function(){$(this).parent("#remove-dialog").addClass("hide"),$(this).parent().parent().find(".popcontent").removeClass("hide"),$(this).parent().parent().find(".edit-marker").removeClass("hide"),$(this).parent().parent().find(".remove-marker").removeClass("hide")}),$(document).off("click",".yes"),$(document).on("click",".yes",function(){map.removeLayer(t)}),$(document).off("click",".edit-marker"),$(document).on("click",".edit-marker",function(){storageMarkers=JSON.parse(localStorage.mapUserMarkers),$(this).parent().find("#iconprev").css("background-image","url("+d+")"),$(this).parent().find("#select_icon").val(r),$(this).addClass("hide"),$(this).next("#edit-dialog").removeClass("hide"),$(this).parent().parent().find(".popcontent").addClass("hide"),$(this).parent().parent().find(".remove-marker").addClass("hide")}),$(document).off("click",".cancel"),$(document).on("click",".cancel",function(){$(this).parent().parent().find("#edit-dialog").addClass("hide"),$(this).parent().parent().find(".popcontent").removeClass("hide"),$(this).parent().parent().find(".edit-marker").removeClass("hide"),$(this).parent().parent().find(".remove-marker").removeClass("hide")}),$(document).off("click",".save-marker"),$(document).on("click",".save-marker",function(){storageMarkers=JSON.parse(localStorage.mapUserMarkers);let r=$(this).parent().find("select[name=icon]").val(),o=$(this).parent().find("#editedtitle").val(),s=$(this).parent().find("#editeddesc").val(),d='<div class="popcontent"><p class="mtitle">'+o+'</p><p class="mdesc">'+s+'</p><span class="mcoords">[ '+a.lng+" , "+a.lat+']</span></div><button class="edit-marker" data-i18n="edit_marker">Edit marker</button><div id="edit-dialog" class="hide"><div class="chooseIcon" data-i18n="choose_icon">Choose Icon:</div>  <div id="iconprev" style="background-image:url(\''+markerIconTypes[0].options.iconUrl+'\')"></div>  <select id="select_icon" name="icon" onchange="iconpref(this.value);">';for(let p in mapMarkers)d+='<option value="'+p+'">'+mapMarkers[p].icon.replace(/_/gi," ")+"</option>";d=d+'</select><input type="text" id="editedtitle" name="title" value="'+o+'"><textarea id="editeddesc" name="desc">'+s+'</textarea><button class="cancel" data-i18n="cancel">Cancel</button><button class="save-marker" data-i18n="Save">Save</button></div><button class="remove-marker" data-i18n="remove_marker">Remove marker</button><div id="remove-dialog" class="hide"><span class="remove-text" data-i18n="remove_text">Are you sure?</span><button class="yes" data-i18n="yes">Yes</button><button class="no" data-i18n="no">No</button></div>',n.setContent(d),storageMarkers.push({coords:{x:l,y:c},name:o,icon:markerIconTypes[r],iconvalue:r,title:o,desc:s}),t.setIcon(markerIconTypes[r]),localStorage.mapUserMarkers=JSON.stringify(storageMarkers),map.removeLayer(t),initUserLayerGroup(),n._close()})}function getFormattedTime(){let t=new Date,a=t.getFullYear(),n=("0"+(t.getMonth()+1)).slice(-2),r=t.getDate(),o=t.getHours(),s=t.getMinutes();return t.getSeconds(),a+"-"+n+"-"+r+"_"+o+"."+s}$(document).on("click",".clearls",function(){$(this).addClass("hide"),$(this).next(".prompt").removeClass("hide")}),$(document).on("click",".clearyes",function(){$(this).parent(".prompt").addClass("hide"),localStorage.setItem("mapUserMarkers","[]"),map.removeLayer(groupUser),initUserLayerGroup()}),$(document).on("click",".clearno",function(){$(this).parent(".prompt").addClass("hide")}),$(".backupls").on("click",function(t){let a={},n=localStorage.mapUserMarkers,r=localStorage.langactive;a.markers=n,a.langactive=r;let o=JSON.stringify(a),s=btoa(o),l=document.createElement("a");l.setAttribute("download","kcdmap_"+getFormattedTime()+".json"),l.setAttribute("href","data:text/javascript;charset=utf-8;base64,"+s),document.querySelector("body").appendChild(l),l.click(),l.remove()}),$(".restorels").on("click",function(t){let a=document.createElement("div");a.className="restoreWindowOverlay";let n=document.createElement("div");n.className="restoreWindow";let r=document.createElement("a");r.className="restoreWindowX",r.appendChild(document.createTextNode("\xd7")),r.setAttribute("href","#"),n.appendChild(r),r.onclick=function(){a.remove()};let o=document.createElement("input");o.setAttribute("type","file"),o.setAttribute("id","fileinput"),o.onchange=function(t){a.remove();let n=t.target.files[0];if(n){let r=new FileReader;r.onload=function(t){let a=t.target.result;a=JSON.parse(a),localStorage.setItem("mapUserMarkers",a.markers),localStorage.setItem("langactive",a.langactive),initUserLayerGroup(),alert("Imported markers from backup.")},r.readAsText(n)}else alert("Failed to load file")};let s=document.createElement("h3");s.className="restoreTitle",s.appendChild(document.createTextNode("Select file with backup")),n.appendChild(s),n.appendChild(o),a.appendChild(n),document.querySelector("body").appendChild(a)}),$(".toggle-title").click(function(){$(this).toggleClass("active"),$(this).next(".hidden-content").slideToggle(500)}),$(".toggle-content").click(function(){$(this).toggleClass("active"),$(this).next(".hidden-content").slideToggle(500)});let langactive=localStorage.getItem("langactive");null===langactive?(localStorage.setItem("langactive","en"),$(".langswitch").find(".lang[data-lang='en']").addClass("active"),$(".langswitch").find(".lang[data-lang='en']").find(".checkmark").addClass("active")):($(".langswitch").find(".lang[data-lang="+langactive+"]").addClass("active"),$(".langswitch").find(".lang[data-lang="+langactive+"]").find(".checkmark").addClass("active")),$(".lang").click(function(){localStorage.setItem("langactive",$(this).data("lang")),$(this).parent().find(".lang-text").removeClass("active"),$(this).find(".lang-text").addClass("active"),$(this).parent().find(".lang").removeClass("active"),$(this).addClass("active"),$(this).parent().find(".checkmark").removeClass("active"),$(this).find(".checkmark").addClass("active")}),$(".markers-list input").on("change",function(){let t,a=[];$(".markers-list input").each(function(){t={id:$(this).attr("id"),value:$(this).prop("checked")},a.push(t)}),localStorage.setItem("activemarkers",JSON.stringify(a))});let activemarkers=JSON.parse(localStorage.getItem("activemarkers"));if(void 0!==localStorage.activemarkers)for(let i=0;i<activemarkers.length;i++)$("#"+activemarkers[i].id).prop("checked",activemarkers[i].value),activemarkers[i].value&&($("#allmarkers").prop("checked",!1),map.addLayer(layerGroups[activemarkers[i].id]));